<% content_for :title, "News Stories - Worldviews" %>

<!-- Animated Background Pattern with Persona Avatars -->
<div class="fixed inset-0 pointer-events-none opacity-10 overflow-hidden z-0">
  <div class="absolute inset-0">
    <%
      # Better distribution across the screen
      positions = [
        { left: 5, top: 10 },    # top left
        { left: 85, top: 8 },    # top right
        { left: 15, top: 45 },   # middle left
        { left: 75, top: 50 },   # middle right
        { left: 10, top: 80 },   # bottom left
        { left: 80, top: 85 },   # bottom right
      ]
    %>
    <% @personas.each_with_index do |persona, index| %>
      <% if persona.avatar_url.present? && positions[index] %>
        <% pos = positions[index] %>
        <!-- Floating avatar bubbles -->
        <div class="absolute rounded-full overflow-hidden shadow-2xl"
             style="
               width: <%= [100, 120, 140, 110, 130, 115][index] %>px;
               height: <%= [100, 120, 140, 110, 130, 115][index] %>px;
               left: <%= pos[:left] %>%;
               top: <%= pos[:top] %>%;
               animation: float-<%= index % 3 %> <%= 15 + (index % 5) %>s ease-in-out infinite;
               animation-delay: <%= index * 0.5 %>s;
             ">
          <%= image_tag persona.avatar_url, alt: "", class: "w-full h-full object-cover" %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<!-- Colorful Gradient Orbs -->
<div class="fixed inset-0 pointer-events-none overflow-hidden z-0">
  <% colors = [
    ['#9333ea', '#ec4899'], # purple to pink
    ['#3b82f6', '#8b5cf6'], # blue to purple
    ['#06b6d4', '#3b82f6'], # cyan to blue
    ['#f59e0b', '#ef4444'], # amber to red
    ['#10b981', '#06b6d4'], # green to cyan
    ['#ec4899', '#f59e0b'], # pink to amber
  ] %>
  <% colors.each_with_index do |(color1, color2), index| %>
    <div class="absolute rounded-full blur-3xl mix-blend-multiply"
         style="
           width: <%= [200, 300, 250, 350][index % 4] %>px;
           height: <%= [200, 300, 250, 350][index % 4] %>px;
           background: radial-gradient(circle, <%= color1 %>, <%= color2 %>);
           left: <%= (index * 19 + 10) % 85 %>%;
           top: <%= (index * 31 + 5) % 75 %>%;
           opacity: 0.15;
           animation: pulse-glow <%= 8 + (index % 4) %>s ease-in-out infinite alternate;
           animation-delay: <%= index * 0.7 %>s;
         ">
    </div>
  <% end %>
</div>

<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative z-10">

  <!-- Search Bar -->
  <div class="mb-8 bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg p-6" data-controller="search">
    <%= form_with url: news_stories_path, method: :get, class: "relative", data: { turbo_frame: "news_stories", search_target: "form", action: "turbo:submit-end->search#hideLoader" } do |f| %>
      <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
        <%= f.text_field :q,
            value: @query,
            placeholder: "Search stories by headline, source, or category...",
            class: "block w-full pl-12 pr-32 py-4 text-lg border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200 bg-white",
            autocomplete: "off",
            data: { search_target: "input", action: "input->search#search" } %>
        <%= f.hidden_field :category, value: params[:category] %>
        <div class="absolute inset-y-0 right-0 flex items-center pr-2 gap-2">
          <!-- Loader -->
          <div data-search-target="loader" class="hidden">
            <svg class="animate-spin h-5 w-5 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
          <% if @query.present? || @category.present? %>
            <%= link_to news_stories_path, class: "px-4 py-2 text-sm text-gray-600 hover:text-gray-900 font-medium" do %>
              Clear
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if @query.present? %>
      <div class="mt-3 text-sm text-gray-600">
        <span class="font-semibold"><%= @news_stories.count %></span>
        <%= @news_stories.count == 1 ? 'story' : 'stories' %> found for
        <span class="font-semibold">"<%= @query %>"</span>
      </div>
    <% end %>
  </div>

  <!-- Category Filter Pills -->
  <div class="mb-8">
    <div class="flex flex-wrap gap-3 items-center">
      <span class="text-sm font-semibold text-gray-700">üìÇ Categories:</span>

      <!-- All Categories -->
      <%= link_to news_stories_path(q: @query),
          class: "px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 #{@category.blank? ? 'bg-purple-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-300'}" do %>
        All
      <% end %>

      <!-- Individual Categories -->
      <% @categories.each do |category| %>
        <%= link_to news_stories_path(category: category, q: @query),
            class: "px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 capitalize #{@category == category ? 'bg-purple-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-300'}" do %>
          <%= case category
              when 'general' then 'üì∞'
              when 'technology' then 'üíª'
              when 'business' then 'üíº'
              when 'science' then 'üî¨'
              when 'health' then 'üè•'
              when 'sports' then '‚öΩ'
              when 'entertainment' then 'üé¨'
              else 'üì∞'
              end %>
          <%= category %>
        <% end %>
      <% end %>
    </div>

    <!-- Active Filter Display -->
    <% if @category.present? %>
      <div class="mt-3 text-sm text-gray-600">
        Showing <span class="font-semibold capitalize"><%= @category %></span> stories
        <% if @query.present? %>
          matching <span class="font-semibold">"<%= @query %>"</span>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- All Stories -->
  <div>
    <h3 class="text-2xl font-bold text-gray-900 mb-6">
      <% if @query.present? %>
        üîç Search Results
      <% else %>
        üì∞ Latest Stories
      <% end %>
    </h3>

    <div data-controller="infinite-scroll">
      <%= render partial: "news_stories_frame", locals: { news_stories: @news_stories, pagy: @pagy, query: @query, category: @category } %>
    </div>
  </div>
</div>
