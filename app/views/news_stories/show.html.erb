<% content_for :title, "#{@news_story.headline} - Worldviews" %>

<!-- Subscribe to Turbo Stream updates for all personas on this page -->
<% @personas.each do |persona| %>
  <%= turbo_stream_from "persona_#{persona.id}" %>
  <%= turbo_stream_from "news_story_#{@news_story.id}_persona_#{persona.id}" %>
<% end %>

<div class="max-w-4xl mx-auto">
  <!-- Back Button -->
  <div class="mb-6">
    <%= link_to root_path, class: "inline-flex items-center text-gray-600 hover:text-gray-900" do %>
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      Back to all stories
    <% end %>
  </div>

  <!-- Story Header -->
  <div class="bg-white rounded-lg shadow-md p-8 mb-8">
    <div class="flex items-center space-x-2 mb-4">
      <span class="text-xs font-semibold text-gray-500 uppercase"><%= @news_story.category %></span>
      <span class="text-xs text-gray-400">â€¢</span>
      <span class="text-xs text-gray-500"><%= @news_story.source %></span>
      <span class="text-xs text-gray-400">â€¢</span>
      <span class="text-xs text-gray-500"><%= time_ago_in_words(@news_story.published_at) %> ago</span>
    </div>

    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
      <%= @news_story.headline %>
    </h1>

    <div class="aspect-video bg-gray-200 rounded-lg overflow-hidden mb-6">
      <img src="<%= @news_story.display_image_url %>" alt="<%= @news_story.headline %>" class="w-full h-full object-cover">
    </div>

    <p class="text-lg text-gray-700 leading-relaxed">
      <%= @news_story.summary %>
    </p>

    <% if @news_story.source_url.present? %>
      <div class="mt-6 pt-6 border-t border-gray-200">
        <a href="<%= @news_story.source_url %>" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
          Read original article â†’
        </a>
      </div>
    <% end %>
  </div>

  <!-- Persona Interpretations -->
  <div class="mb-8">
    <h2 class="text-2xl font-bold text-gray-900 mb-2 text-center">
      ðŸŽ­ How Different Worldviews See This
    </h2>
    <p class="text-gray-600 text-center mb-6">
      Swipe or click to switch between personas
    </p>

    <!-- Persona Carousel -->
    <div data-controller="persona-carousel" class="relative">
      <!-- Persona Tabs -->
      <div class="flex overflow-x-auto space-x-2 mb-6 pb-2 scrollbar-hide">
        <% if @custom_personas.any? %>
          <div class="flex-shrink-0 text-xs font-semibold text-purple-600 uppercase tracking-wide px-2 py-2 flex items-center">
            âœ¨ Your Personas
          </div>
          <% @custom_personas.each_with_index do |persona, index| %>
            <button
              data-persona-carousel-target="tab"
              data-action="click->persona-carousel#selectPersona"
              data-index="<%= index %>"
              class="flex-shrink-0 px-4 py-2 rounded-full font-semibold text-sm transition-all duration-200 <%= index == 0 ? 'text-white' : 'bg-white text-gray-700 hover:bg-gray-100' %> border-2 border-purple-200"
              style="<%= index == 0 ? "background-color: #{persona.color_primary};" : '' %>"
            >
              <%= persona.name %>
            </button>
          <% end %>
        <% end %>

        <% if @official_personas.any? %>
          <div class="flex-shrink-0 text-xs font-semibold text-gray-500 uppercase tracking-wide px-2 py-2 flex items-center <%= @custom_personas.any? ? 'border-l-2 border-gray-200 ml-2 pl-4' : '' %>">
            Official
          </div>
          <% @official_personas.each_with_index do |persona, official_index| %>
            <% index = @custom_personas.length + official_index %>
            <button
              data-persona-carousel-target="tab"
              data-action="click->persona-carousel#selectPersona"
              data-index="<%= index %>"
              class="flex-shrink-0 px-4 py-2 rounded-full font-semibold text-sm transition-all duration-200 bg-white text-gray-700 hover:bg-gray-100"
            >
              <%= persona.name %>
            </button>
          <% end %>
        <% end %>
      </div>

      <!-- Interpretation Cards -->
      <div class="relative overflow-hidden" data-persona-carousel-target="container">
        <% @personas.each_with_index do |persona, index| %>
          <% interpretation = @interpretations[persona.id] %>
          <div
            data-persona-carousel-target="card"
            data-index="<%= index %>"
            class="<%= index == 0 ? '' : 'hidden' %> transition-all duration-300"
          >
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border-4" style="border-color: <%= persona.color_primary %>;">
              <!-- Persona Header -->
              <div class="p-6" style="background: linear-gradient(135deg, <%= persona.color_primary %>20 0%, <%= persona.color_secondary || persona.color_primary %>10 100%);">
                <%= link_to persona_path(persona), class: "flex items-center space-x-4 group" do %>
                  <div id="persona_avatar_<%= persona.id %>">
                    <%= render "personas/avatar", persona: persona %>
                  </div>
                  <div>
                    <h3 class="text-2xl font-bold text-gray-900 group-hover:underline"><%= persona.name %></h3>
                    <p class="text-gray-600 italic">"<%= persona.description %>"</p>
                  </div>
                <% end %>
              </div>

              <!-- Interpretation Content -->
              <div class="p-8">
                <div id="interpretation_content_<%= @news_story.id %>_persona_<%= persona.id %>">
                  <% if interpretation %>
                    <%= render "interpretations/content", interpretation: interpretation, persona: persona %>
                  <% else %>
                    <%= render "interpretations/loading", persona: persona %>
                  <% end %>
                </div>

                <!-- Share This Interpretation -->
                <% if interpretation %>
                  <div class="mt-6 pt-6 border-t border-gray-200">
                    <div
                      data-controller="share"
                      data-share-url-value="<%= interpretation_url(interpretation) %>"
                      data-share-title-value="<%= persona.name %>'s take on: <%= @news_story.headline %>"
                      data-share-text-value="Check out <%= persona.name %>'s perspective: <%= @news_story.headline %>"
                      class="flex items-center justify-between"
                    >
                      <p class="text-sm text-gray-600 font-medium">Share <%= persona.name %>'s take:</p>
                      <div class="flex space-x-2">
                        <button
                          data-action="click->share#share"
                          class="inline-flex items-center px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-200 hover:scale-105"
                          style="background-color: <%= persona.color_primary %>20; color: <%= persona.color_primary %>;"
                          title="Share this interpretation"
                        >
                          <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                          </svg>
                          Share
                        </button>
                        <a
                          href="https://twitter.com/intent/tweet?text=<%= CGI.escape("#{persona.name}'s take: #{@news_story.headline}") %>&url=<%= CGI.escape(interpretation_url(interpretation)) %>"
                          target="_blank"
                          rel="noopener"
                          class="inline-flex items-center px-4 py-2 bg-black text-white text-sm font-semibold rounded-lg hover:bg-gray-800 transition-all duration-200 hover:scale-105"
                          title="Share on X/Twitter"
                        >
                          <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                          </svg>
                          Tweet
                        </a>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Navigation Arrows -->
      <button
        data-action="click->persona-carousel#previous"
        class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 bg-white rounded-full p-3 shadow-lg hover:bg-gray-100 transition-colors"
      >
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <button
        data-action="click->persona-carousel#next"
        class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 bg-white rounded-full p-3 shadow-lg hover:bg-gray-100 transition-colors"
      >
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Create Your Own Persona CTA (if not logged in or no custom personas) -->
  <% if !user_signed_in? || @custom_personas.empty? %>
    <div class="mb-8 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-8 text-white">
      <div class="text-center">
        <div class="text-4xl mb-3">âœ¨</div>
        <h3 class="text-2xl font-bold mb-3">
          <% if user_signed_in? %>
            Create Your Own Persona
          <% else %>
            Want to See Your Own Worldview?
          <% end %>
        </h3>
        <p class="text-white/90 mb-6 max-w-2xl mx-auto">
          <% if user_signed_in? %>
            Design a custom persona and see how it interprets this story and all future news!
          <% else %>
            Sign up to create custom personas and see how your unique worldview interprets the news.
          <% end %>
        </p>
        <% if user_signed_in? %>
          <%= link_to new_persona_path, class: "inline-flex items-center px-8 py-3 bg-white text-purple-600 rounded-xl font-bold hover:bg-gray-100 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105" do %>
            <svg class="mr-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Create My Persona
          <% end %>
        <% else %>
          <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
            <%= link_to new_user_registration_path, class: "inline-flex items-center px-8 py-3 bg-white text-purple-600 rounded-xl font-bold hover:bg-gray-100 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105" do %>
              <svg class="mr-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
              </svg>
              Sign Up Free
            <% end %>
            <%= link_to new_user_session_path, class: "inline-flex items-center px-6 py-2 bg-white/20 backdrop-blur-sm text-white border-2 border-white/30 rounded-xl font-semibold hover:bg-white/30 transition-all duration-300" do %>
              Already have an account? Login
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Share Section -->
  <div
    class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 text-center"
    data-controller="share"
    data-share-url-value="<%= news_story_url(@news_story) %>"
    data-share-title-value="<%= @news_story.headline %>"
    data-share-text-value="Check out how different worldviews see this story: <%= @news_story.headline %>"
  >
    <h3 class="text-lg font-bold text-gray-900 mb-2">Share This Reality Check</h3>
    <p class="text-gray-600 text-sm mb-4">Show your friends how the same news looks through different lenses</p>
    <div class="flex justify-center space-x-3">
      <button
        data-action="click->share#share"
        class="bg-blue-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-700 transition-colors"
      >
        ðŸ“± Share
      </button>
      <button
        data-action="click->share#screenshot"
        class="bg-white text-gray-700 px-6 py-2 rounded-full font-semibold hover:bg-gray-100 transition-colors"
      >
        ðŸ“¸ Screenshot
      </button>
    </div>
  </div>
</div>
