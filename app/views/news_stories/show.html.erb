<% content_for :title, "#{@news_story.headline} - Worldviews" %>

<div class="max-w-4xl mx-auto">
  <!-- Back Button -->
  <div class="mb-6">
    <%= link_to root_path, class: "inline-flex items-center text-gray-600 hover:text-gray-900" do %>
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      Back to all stories
    <% end %>
  </div>

  <!-- Story Header -->
  <div class="bg-white rounded-lg shadow-md p-8 mb-8">
    <div class="flex items-center space-x-2 mb-4">
      <span class="text-xs font-semibold text-gray-500 uppercase"><%= @news_story.category %></span>
      <span class="text-xs text-gray-400">‚Ä¢</span>
      <span class="text-xs text-gray-500"><%= @news_story.source %></span>
      <span class="text-xs text-gray-400">‚Ä¢</span>
      <span class="text-xs text-gray-500"><%= time_ago_in_words(@news_story.published_at) %> ago</span>
    </div>

    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
      <%= @news_story.headline %>
    </h1>

    <% if @news_story.image_url.present? %>
      <div class="aspect-video bg-gray-200 rounded-lg overflow-hidden mb-6">
        <img src="<%= @news_story.image_url %>" alt="<%= @news_story.headline %>" class="w-full h-full object-cover">
      </div>
    <% end %>

    <p class="text-lg text-gray-700 leading-relaxed">
      <%= @news_story.summary %>
    </p>

    <% if @news_story.source_url.present? %>
      <div class="mt-6 pt-6 border-t border-gray-200">
        <a href="<%= @news_story.source_url %>" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
          Read original article ‚Üí
        </a>
      </div>
    <% end %>
  </div>

  <!-- Persona Interpretations -->
  <div class="mb-8">
    <h2 class="text-2xl font-bold text-gray-900 mb-2 text-center">
      üé≠ How Different Worldviews See This
    </h2>
    <p class="text-gray-600 text-center mb-6">
      Swipe or click to switch between personas
    </p>

    <!-- Persona Carousel -->
    <div data-controller="persona-carousel" class="relative">
      <!-- Persona Tabs -->
      <div class="flex overflow-x-auto space-x-2 mb-6 pb-2 scrollbar-hide">
        <% if @official_personas.any? %>
          <div class="flex-shrink-0 text-xs font-semibold text-gray-500 uppercase tracking-wide px-2 py-2 flex items-center">
            Official
          </div>
        <% end %>
        <% @official_personas.each_with_index do |persona, index| %>
          <button
            data-persona-carousel-target="tab"
            data-action="click->persona-carousel#selectPersona"
            data-index="<%= index %>"
            class="flex-shrink-0 px-4 py-2 rounded-full font-semibold text-sm transition-all duration-200 <%= index == 0 ? 'text-white' : 'bg-white text-gray-700 hover:bg-gray-100' %>"
            style="<%= index == 0 ? "background-color: #{persona.color_primary};" : '' %>"
          >
            <%= persona.name %>
          </button>
        <% end %>

        <% if @custom_personas.any? %>
          <div class="flex-shrink-0 text-xs font-semibold text-purple-600 uppercase tracking-wide px-2 py-2 flex items-center border-l-2 border-purple-200 ml-2 pl-4">
            ‚ú® Your Personas
          </div>
          <% @custom_personas.each_with_index do |persona, custom_index| %>
            <% index = @official_personas.length + custom_index %>
            <button
              data-persona-carousel-target="tab"
              data-action="click->persona-carousel#selectPersona"
              data-index="<%= index %>"
              class="flex-shrink-0 px-4 py-2 rounded-full font-semibold text-sm transition-all duration-200 bg-white text-gray-700 hover:bg-gray-100 border-2 border-purple-200"
            >
              <%= persona.name %>
            </button>
          <% end %>
        <% end %>
      </div>

      <!-- Interpretation Cards -->
      <div class="relative overflow-hidden" data-persona-carousel-target="container">
        <% @personas.each_with_index do |persona, index| %>
          <% interpretation = @interpretations[persona.id] %>
          <div
            data-persona-carousel-target="card"
            data-index="<%= index %>"
            class="<%= index == 0 ? '' : 'hidden' %> transition-all duration-300"
          >
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border-4" style="border-color: <%= persona.color_primary %>;">
              <!-- Persona Header -->
              <div class="p-6" style="background: linear-gradient(135deg, <%= persona.color_primary %>20 0%, <%= persona.color_secondary || persona.color_primary %>10 100%);">
                <%= link_to persona_path(persona), class: "flex items-center space-x-4 group" do %>
                  <% if persona.avatar_url.present? %>
                    <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-white shadow-lg">
                      <%= image_tag persona.avatar_url, alt: persona.name, class: "w-full h-full object-cover" %>
                    </div>
                  <% else %>
                    <div class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white" style="background-color: <%= persona.color_primary %>;">
                      <%= persona.name[0] %>
                    </div>
                  <% end %>
                  <div>
                    <h3 class="text-2xl font-bold text-gray-900 group-hover:underline"><%= persona.name %></h3>
                    <p class="text-gray-600 italic">"<%= persona.description %>"</p>
                  </div>
                <% end %>
              </div>

              <!-- Interpretation Content -->
              <div class="p-8">
                <% if interpretation %>
                  <div class="relative">
                    <!-- Speech Bubble -->
                    <div class="bg-gray-50 rounded-2xl p-6 relative">
                      <div class="absolute -top-3 left-8 w-6 h-6 bg-gray-50 transform rotate-45"></div>
                      <p class="text-lg text-gray-900 leading-relaxed relative z-10">
                        <%= interpretation.content %>
                      </p>
                    </div>

                    <!-- Metadata & Actions -->
                    <div class="mt-4 flex items-center justify-between">
                      <div class="text-xs text-gray-500">
                        <span>Generated by <%= interpretation.llm_model %></span>
                        <span class="mx-2">‚Ä¢</span>
                        <span><%= interpretation.generation_time_ms %>ms ‚Ä¢ <%= interpretation.llm_tokens_used %> tokens</span>
                      </div>
                      <%= link_to interpretation_path(interpretation), class: "inline-flex items-center space-x-1 text-sm font-medium hover:underline", style: "color: #{persona.color_primary};" do %>
                        <span>üìù Read Full Opinion</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                      <% end %>
                    </div>
                  </div>
                <% else %>
                  <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 mx-auto mb-4" style="border-color: <%= persona.color_primary %>;"></div>
                    <p class="text-gray-600">Generating <%= persona.name %>'s take...</p>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Navigation Arrows -->
      <button
        data-action="click->persona-carousel#previous"
        class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 bg-white rounded-full p-3 shadow-lg hover:bg-gray-100 transition-colors"
      >
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <button
        data-action="click->persona-carousel#next"
        class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 bg-white rounded-full p-3 shadow-lg hover:bg-gray-100 transition-colors"
      >
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Create Your Own Persona CTA (if not logged in or no custom personas) -->
  <% if !user_signed_in? || @custom_personas.empty? %>
    <div class="mb-8 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-8 text-white">
      <div class="text-center">
        <div class="text-4xl mb-3">‚ú®</div>
        <h3 class="text-2xl font-bold mb-3">
          <% if user_signed_in? %>
            Create Your Own Persona
          <% else %>
            Want to See Your Own Worldview?
          <% end %>
        </h3>
        <p class="text-white/90 mb-6 max-w-2xl mx-auto">
          <% if user_signed_in? %>
            Design a custom persona and see how it interprets this story and all future news!
          <% else %>
            Sign up to create custom personas and see how your unique worldview interprets the news.
          <% end %>
        </p>
        <% if user_signed_in? %>
          <%= link_to new_persona_path, class: "inline-flex items-center px-8 py-3 bg-white text-purple-600 rounded-xl font-bold hover:bg-gray-100 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105" do %>
            <svg class="mr-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Create My Persona
          <% end %>
        <% else %>
          <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
            <%= link_to new_user_registration_path, class: "inline-flex items-center px-8 py-3 bg-white text-purple-600 rounded-xl font-bold hover:bg-gray-100 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105" do %>
              <svg class="mr-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
              </svg>
              Sign Up Free
            <% end %>
            <%= link_to new_user_session_path, class: "inline-flex items-center px-6 py-2 bg-white/20 backdrop-blur-sm text-white border-2 border-white/30 rounded-xl font-semibold hover:bg-white/30 transition-all duration-300" do %>
              Already have an account? Login
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Share Section -->
  <div
    class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 text-center"
    data-controller="share"
    data-share-url-value="<%= news_story_url(@news_story) %>"
    data-share-title-value="<%= @news_story.headline %>"
    data-share-text-value="Check out how different worldviews see this story: <%= @news_story.headline %>"
  >
    <h3 class="text-lg font-bold text-gray-900 mb-2">Share This Reality Check</h3>
    <p class="text-gray-600 text-sm mb-4">Show your friends how the same news looks through different lenses</p>
    <div class="flex justify-center space-x-3">
      <button
        data-action="click->share#share"
        class="bg-blue-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-700 transition-colors"
      >
        üì± Share
      </button>
      <button
        data-action="click->share#screenshot"
        class="bg-white text-gray-700 px-6 py-2 rounded-full font-semibold hover:bg-gray-100 transition-colors"
      >
        üì∏ Screenshot
      </button>
    </div>
  </div>
</div>
